# Snowplow Terraform Provider

[![Build Status][travis-image]][travis] [![Go Report Card][goreport-image]][goreport] [![Release][release-image]][releases] [![License][license-image]][license]

## Overview

Terraform provider for emitting Snowplow events.

## Quick start

Assuming git, **[Vagrant][vagrant-url]** and **[VirtualBox][virtualbox-url]** installed:

```bash
 host> git clone https://github.com/snowplow-devops/terraform-provider-snowplow
 host> cd terraform-provider-snowplow
 host> vagrant up && vagrant ssh
guest> cd /opt/gopath/src/github.com/snowplow/terraform-provider-snowplow
guest> make test
guest> make
```

To remove all build files:

```bash
guest> make clean
```

To format the golang code in the source directory:

```bash
guest> make format
```

**Note:** Always run `format` before submitting any code.

**Note:** The `make test` command also generates a code coverage file which can be found at `build/coverage/coverage.html`.

## Installation

First download the pre-compiled binary for your platform from our Bintray at the following links or generate the binaries locally using the provided `make` command:

* [Darwin (macOS)](https://bintray.com/snowplow/snowplow-generic/download_file?file_path=terraform_provider_snowplow_0.3.0_darwin_amd64.zip)
* [Linux](https://bintray.com/snowplow/snowplow-generic/download_file?file_path=terraform_provider_snowplow_0.3.0_linux_amd64.zip)
* [Windows](https://bintray.com/snowplow/snowplow-generic/download_file?file_path=terraform_provider_snowplow_0.3.0_windows_amd64.zip)

Once downloaded "unzip" to extract the binary which should be called `terraform-provider-snowplow_v0.3.0`.

From here you will need to move the binary into your Terraform plugins directory - depending on your platform / installation this might change but generally speaking they are located at:

* Darwin & Linux: `~/.terraform.d/plugins`
* Windows: `%APPDATA%\terraform.d\plugins`

## How to use?

### Setting up the provider

To actually start tracking Snowplow events from Terraform you will need to configure the `provider` and a `resource`:

```hcl
# Minimal configuration
provider "snowplow" {
  collector_uri = "com.acme.collector"
}

# Optional extra configuration options
provider "snowplow" {
  collector_uri        = "com.acme.collector"
  tracker_app_id       = "terraform" # Default; ""
  tracker_namespace    = "terraform" # Default; ""
  tracker_platform     = "mob" # Default; srv (server)
  emitter_request_type = "GET" # Default; POST
  emitter_protocol     = "HTTP" # Default; HTTPS
}
```

Now that the provider is configured we can track an event!

### Tracking events

Currently only one tracking resource has been exposed in the form of a `SelfDescribing Event` - the other pre-built options do not really make sense in a Terraform world!

#### How to track: `self_describing_event`

```hcl
locals {
  tf_module_context = {
    name    = "aws_module"
    version = "1.1.2"
  }
}

resource "snowplow_track_self_describing_event" "module_action" {
  create_event {
    iglu_uri = "iglu:com.acme/lifecycle/jsonschema/1-0-0"

    payload  = {
      actionType = "create"
    }
  }

  update_event {
    iglu_uri = "iglu:com.acme/lifecycle/jsonschema/1-0-0"

    payload = {
      actionType = "update"
    }
  }

  delete_event {
    iglu_uri = "iglu:com.acme/lifecycle/jsonschema/1-0-0"

    payload = {
      actionType = "delete"
    }
  }

  // Add multiple context blocks

  context {
    iglu_uri = "iglu:com.acme/module_context/jsonschema/1-0-0"

    payload = {
      foo = "bar"
    }
  }
}
```

The above function lets you define a single event which is coupled with as many contexts as you would like to attach - when you run `terraform apply` it will send an event to your defined collector and on a `200 OK` response code from the collector log this as a successful resource creation.

Its important to define a base event for _each_ part of the resource lifecycle so that you can differentiate your events later and to be able to reason about where in the lifecycle a resource might be.
 
### Publishing

This is handled through CI/CD on Travis. However all binaries will be generated by using the `make` command for local publishing.

### Copyright and license

Snowplow Terraform Provider is copyright 2019-2020 Snowplow Analytics Ltd.

Licensed under the **[Apache License, Version 2.0][license]** (the "License");
you may not use this software except in compliance with the License.

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

[travis-image]: https://travis-ci.com/snowplow-devops/terraform-provider-snowplow.png?branch=master
[travis]: https://travis-ci.com/snowplow-devops/terraform-provider-snowplow

[release-image]: http://img.shields.io/badge/release-0.3.0-6ad7e5.svg?style=flat
[releases]: https://github.com/snowplow-devops/terraform-provider-snowplow/releases

[license-image]: http://img.shields.io/badge/license-Apache--2-blue.svg?style=flat
[license]: http://www.apache.org/licenses/LICENSE-2.0

[goreport-image]: https://goreportcard.com/badge/github.com/snowplow-devops/terraform-provider-snowplow
[goreport]: https://goreportcard.com/report/github.com/snowplow-devops/terraform-provider-snowplow

[vagrant-url]: http://docs.vagrantup.com/v2/installation/index.html
[virtualbox-url]: https://www.virtualbox.org/wiki/Downloads
